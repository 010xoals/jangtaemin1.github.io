<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Release Calendar — Music Discovery Hub</title>
  <meta name="description" content="Weekly and monthly view of upcoming releases across K-POP, J-POP, and POP.">
  <meta property="og:title" content="Release Calendar — Music Discovery Hub">
  <meta property="og:description" content="Weekly and monthly view of upcoming releases across K-POP, J-POP, and POP.">
  <meta property="og:type" content="website">
  <meta property="og:image" content="https://picsum.photos/seed/calendar-og/1200/630">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- 기존 프로젝트 구조를 유지하려고 CSS는 절대경로 그대로 둡니다 -->
  <link rel="stylesheet" href="/assets/css/style.css">
</head>
<body>
  <!-- Header (프로젝트의 다른 페이지와 동일) -->
  <header class="site-header">
    <div class="container h-wrap">
      <a class="brand" href="/"><span class="logo">Mu</span><strong>Music Discovery Hub</strong></a>
      <nav class="tabs">
        <a class="tab" href="/kpop.html">K-POP</a>
        <a class="tab" href="/jpop.html">J-POP</a>
        <a class="tab" href="/pop.html">POP</a>
        <a class="tab" href="/calendar.html">Calendar</a>
        <a class="tab" href="/artists/index.html">Artists</a>
        <a class="tab" href="/games.html">Vote</a>
        <a class="tab" href="/news.html">News</a>
      </nav>
    </div>
    <div id="ad_top_leaderboard" class="ad ad-leader">AD TOP 970×250 / 320×100</div>
  </header>

  <main class="container">
    <section class="hero">
      <h1>Release Calendar</h1>
      <p>Weekly & monthly view of upcoming releases across genres.</p>
    </section>

    <div class="searchbar">
      <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center">
        <input id="q" placeholder="Filter by artist or song…" />
        <select id="region">
          <option value="">All Regions</option>
          <option value="KR">KR</option>
          <option value="JP">JP</option>
          <option value="US">US</option>
          <option value="Global">Global</option>
        </select>
      </div>
      <button id="refresh" class="btn" style="width:auto">↻ Refresh</button>
    </div>

    <table class="table" id="cal"></table>

    <div id="ad_in_article_cal" class="ad infeed">AD In-Article</div>
  </main>

  <footer class="site-footer">
    <div class="container f-wrap">
      <div>© <span id="year"></span> Music Discovery Hub · Built by jangtaemin1.com</div>
      <div class="links">
        <a href="/privacy.html">Privacy</a>
        <a href="/ads.html">Ads</a>
        <a href="/contact.html">Contact</a>
        <a href="/rss.xml">RSS</a>
      </div>
    </div>
  </footer>

  <!-- 기존 프로젝트 구조 유지 위해 JS도 절대경로 -->
  <script src="/assets/js/app.js"></script>

  <script>
    // 상대경로 + 캐시버스터로 항상 최신 JSON을 불러옵니다.
    const bust = () => '?t=' + Date.now();
    const $ = (sel) => document.querySelector(sel);

    function drawTable(rows, mapSong, mapArtist) {
      const cal = $('#cal');
      cal.innerHTML = '<thead><tr><th>Date</th><th>Song</th><th>Artist</th><th>Region</th></tr></thead>';
      const tb = document.createElement('tbody');
      rows.forEach(r => {
        const s = mapSong[r.song_id] || {};
        const a = mapArtist[s.artist_id] || {};
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.release_at || ''}</td>
          <td>${s.title ? `<a href="./song.html?slug=${encodeURIComponent(s.slug || s.id)}">${s.title}</a>` : (r.song_id || '')}</td>
          <td>${a.name ? `<a href="./artist.html?slug=${encodeURIComponent(a.slug || a.id)}">${a.name}</a>` : (s.artist_id || '')}</td>
          <td>${r.region || ''}</td>`;
        tb.appendChild(tr);
      });
      cal.appendChild(tb);
    }

    async function loadData() {
      // 상대경로(./) 사용: 서브경로에 배포해도 안전
      const [artists, songs, releases] = await Promise.all([
        fetch('./data/artists.json' + bust()).then(r => r.json()),
        fetch('./data/songs.json' + bust()).then(r => r.json()),
        fetch('./data/releases.json' + bust()).then(r => r.json())
      ]);

      // 맵 구성
      const mapSong = Object.fromEntries((songs || []).map(s => [s.id, s]));
      const mapArtist = Object.fromEntries((artists || []).map(a => [a.id, a]));

      // 기본 정렬: 날짜 오름차순
      let base = (releases || []).slice().sort((a, b) => (a.release_at || '').localeCompare(b.release_at || ''));

      // 필터 핸들러
      function applyFilters() {
        const q = ($('#q').value || '').toLowerCase();
        const region = $('#region').value;
        let list = base;

        if (region) list = list.filter(r => (r.region || '') === region);

        if (q) {
          list = list.filter(r => {
            const s = mapSong[r.song_id] || {};
            const a = mapArtist[s.artist_id] || {};
            return [s.title || '', a.name || '', r.song_id || ''].some(x => String(x).toLowerCase().includes(q));
          });
        }

        drawTable(list, mapSong, mapArtist);
      }

      // 초기 렌더 + 이벤트 바인딩
      applyFilters();
      $('#q').addEventListener('input', applyFilters);
      $('#region').addEventListener('change', applyFilters);
      $('#refresh').addEventListener('click', async () => {
        // 강제 최신 로드
        await loadData(); // 재귀처럼 보이지만 새로 fetch 후 이벤트 재바인딩이 되므로 아래 보호
      });
    }

    // 첫 로드
    loadData();
  </script>
</body>
</html>
